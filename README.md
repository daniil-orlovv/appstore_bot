# AppStoreBot

# Описание проекта
Telegram-бот, осуществляющий мониторинг доступности выбранных iOS приложений в App Store по URL и информирует пользователей о любых изменениях в их доступности.

Возможности администратора: 
- добавление приложений в бота, с указанием url, названия и ссылки для запуска(`/add`)
- удаление приложений из бота(`/remove`)
- установка интервала(`/setinterval`)
- генерация ключа доступа для пользователей(`/generatekey`)
- отправка сообщения всем пользователям бота(`/broadcast`)

Возможности пользователя:
- получение доступа к боту с помощью кода доступа, полученного у администратор(`/start`)
- получение статуса приложений, на обновления которых он подписан(`/status`)
- возможность подписки на приложения(`/subscribe`)
- получение ссылки для запуска приложения(`/getlaunchlinks`)

Возможности бота:
- бот периодически (интервал проверки задается администратором) отправляет запросы к страницам приложений в App Store. Приложение считается недоступным только после трех последовательных
неуспешных запросов, каждый успешный запрос сбрасывает счетчик неуспешных попыток на ноль
- в случае обнаружения недоступности приложения, бот отправляет уведомление всем подписанным пользователям о данном событии



# Установка, настройка и запуск проекта

### Запуск на компьютере
1. Сохранить проект в выбранную директорию: `git clone git@github.com:daniil-orlovv/appstore_bot.git`
2. Установить виртуальное окружение, находясь в корне проекта: `python -m venv venv`
3. Активировать виртуальное окружение: `source venv/scripts/activate`
4. Установить зависимости из файла requirements.txt: `pip install -r requirements.txt`
5. Создать файл .env и заполнить его по подобию .env.exapmle, указав:
   - BOT_TOKEN(можно получить в телеграм-боте `Bot Father`, создав своего бота)
   - INTERVAL_MINUTES(предварительная настройка интервала проверки доступа приложений в минутах)
   - ADMIN_IDS(Список админов приложения, необходимо указать свой TELEGRAM_ID или пользователя, которого нужно назначить админом)
6. Создать и выполнить миграции с помощью `alembic`:
   - Перейти в корень и инициализировать `alembic`: `alembic init alembic`
   - В файле alembic.ini указать путь до файла базы данных sqlite3: `sqlalchemy.url = sqlite:///sqlite3.db`
   - По пути `alembic/` находим `env.py`и меняем строку `target_metadata = None` на:
      ```
      # Импорт вышестоящего каталога
      import os
      import sys
      sys.path.insert(0, '/'.join(os.path.dirname(os.path.abspath(__file__)).split('/')[:-1]))

      from myapp.mymodel import Base
      target_metadata = Base.metadata
      ```
      где `myapp.mymodel` путь до моделей БД -> `models.models`
   - Создаем миграции: `alembic revision --message="Initial" --autogenerate`
   - Применяем миграции: `alembic upgrade head`
7. Запускаем бота с помощью `python main.py`

### Запуск на сервере без докера
...

### Запуск на сервере с докером
...

# Описание команд 
Администратор:
- `/add [урл приложения] [название приложения] [ссылка запуска]`: Администратор добавляет приложение с помощью этой команды, указывая обязательно через пробел урл, название и ссылку запуска. Все приложения сохраняются в БД.
- `/remove`: Администратор удаляет приложение. При нажатии на кнопку возвращается список кнопок с приложениями, при нажатии на которые, выбранное приложение удаляется.
- `/setinterval [значение в минутах]`: Администратор устанавливает интервал для проверки ботом доступности приложений, отправляю команду со значением в минутах, обязательно через пробел.
- `/generatekey [значение]`: Администратор генерирует код доступа для пользователей, отправляя команду вместе со значением кода, обязательно через пробел. Далее, сообщает код пользователю для его дальнейшей авторизации. После авторизации пользователя код автоматически удаляется.
- `broadcast [сообщение]`: Администратор с помощью этой команды отправляет сообщение всем пользователям бота, указав через пробел сообщение, которое нужно всем отправить.

Пользователь:
- `/start [код доступа]`: Пользователь активирует бота с помощью кода, полученного у администратора, обязательно через пробел после команды.
- `/subscribe`: Пользователь отправляет команду, в ответ ботом отправляется список приложений, на которые можно создать подписку. Пользователь выбирает приложение - создается подписка.
- `/status`: При отправке команды возвращаются статусы приложений, на которые подписан пользователь.
- `/getlaunchlinks`: Команда позволяет пользователю получить ссылки для запуска выбранных приложений. При отправке команды - бот отправляет список приложений. Пользователь выбирате приложение, в ответ приходит ссылка для запуска приложения.

Все команды для пользователя продублированы кнопками в телеграм-боте.

# Описание структуры проекта
- `config_data/config.py` - предназначен для хранения конфигов проекта, а именно токен бота, список админов, интервал проверки. Также, для загрузки конфигов при запуске и обновления интервала проверки.
- `filters/`:
  - `filters.py` - фильтр для проверки приложения в БД
  - `permissions.py` - фильтры для проверки прав(Админ, Авторизованный)
- `handlers/`:
  - `admin_handlers.py` - обработчики, предназначенные для команд администратора
  - `user_handlers.py` - обработчики, предназначенные для команд пользователя
- `keyboards/keyboards_builser.py` - билдер для создания обычных и инлайн-клавиатур
- `lexicon/`:
  - `admin_handlers.py` - словарь для подстановки текста в обработчики команд админа
  - `user_handlers.py` - словарь для подстановки текста в обработчики команд пользователя
- `middlewares/middleware.py` - мидлварь, отвечающий за создание сессии БД перед фильтрами и передачу его в обработчики
- `models/models.py` - модели БД
- `states/state.py` - состояния FSM
- `utils/`:
  - `utils_db.py` - утилиты(функции) для взаимодейстия с БД
  - `utils.py` - утилиты(функции) для проверки доступности приложений
- `main.py` - точка входа в бота

# Стек технологий

- aiogram
- aiohttp
- SQLAlchemy
- alembic
- APScheduler
- environs
- python-dotenv
- logging
